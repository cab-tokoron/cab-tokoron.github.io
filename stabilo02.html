<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <span>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <button id="save">Save</button>
    </span>
    <span>
        <div>
            <div id="dataX">XG:</div>
            <div id="dataZ">ZG:</div>
        </div>
    <div><canvas id="stabilometer"></canvas></div>
    <!--div id="stabilometer"></div-->
    
    <script>
        var xg = 0.0;
        var yg = 0.0;
        var zg = 0.0;
        var pre_x = 0.0;
        var pre_y = 0.0;
        let intervalId = 0;
        var graph_area = document.getElementById("stabilometer");
        var graph_ctx = graph_area.getContext("2d");
        graph_ctx.lineJoin = "round";
        graph_ctx.lineCap = "round";
        var dataX = document.getElementById("dataX");
        var dataZ = document.getElementById("dataZ");
        
        var counter = 0;
        var res_text = "";
        
        window.onload = ()=>{
            initGraph();
        };

        window.ondevicemotion = (evt)=>{
            xg = evt.accelerationIncludingGravity.x;
            yg = evt.accelerationIncludingGravity.y;
            zg = evt.accelerationIncludingGravity.z;    
        };

        document.getElementById("start").onclick = ()=>{
            
            res_text = 'X\tY\n';
            counter = 0;
            intervalId = setInterval(() =>{
                let crt_x = -xg * 40 + 320;
                let crt_y = -zg * 40 + 320;
                dataX.innerHTML = "XG: " + xg.toFixed(4);
                dataZ.innerHTML = "ZG: " + zg.toFixed(4);
                
                if (counter>200){
                    graph_ctx.beginPath();
                    graph_ctx.moveTo(pre_x, pre_y);
                    graph_ctx.lineTo(crt_x, crt_y);
                    graph_ctx.closePath();
                    graph_ctx.stroke();
                }
                pre_x = crt_x;
                pre_y = crt_y;
                counter ++;
                if (counter>2600){
                    clearInterval(intervalId);
                } 
            }, 25);
        };

        document.getElementById("stop").onclick = ()=>{
            clearInterval(intervalId);
        };

        document.getElementById("save").onclick = ()=>{
            let blob = new Blob([res_text], {type: 'text/plain'});
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.target = '_blank';
            a.download = fname;
            a.click();
        };

        function initGraph(){
            graph_area.width = 640;
            graph_area.height = 640;
            graph_ctx.lineWidth = 2;
            graph_ctx.fillStyle = "white";
            graph_ctx.fillRect(0,0,640,640);
            graph_ctx.fill();
            graph_ctx.strokeStyle = "black";
            graph_ctx.strokeRect(20,20,600,600);
            for (let i=1;i<8;i++){
                graph_ctx.moveTo(20+i*75, 20);
                graph_ctx.lineTo(20+i*75,620);
                graph_ctx.moveTo( 20,20+i*75);
                graph_ctx.lineTo(620,20+i*75);
            }
            graph_ctx.stroke();
            graph_ctx.fillRect(30,30,580,580);
            graph_ctx.fill();
            graph_ctx.strokeStyle = "red";
        }

    </script>
</body>
</html>
